<?php
class DonationCampaigns {
    private $conn;

    public function __construct(PDO $conn) {
        $this->conn = $conn;
    }




    public function createCampaign($staff_id, $name, $date, $location, $description, $target_units, $latitude, $longitude) {
    $stmt = $this->conn->prepare("INSERT INTO donation_campaigns 
        (staff_id, campaign_name, campaign_date, location, description, target_units, latitude, longitude, status) 
        VALUES (?, ?, ?, ?, ?, ?, ?, ?, 'active')");

    $success = $stmt->execute([
        $staff_id, $name, $date, $location, $description,
        $target_units, $latitude, $longitude
    ]);

    if ($success) {
        $campaign_id = $this->conn->lastInsertId();

        // ‚úÖ ÿßÿ≥ÿ™ÿØÿπÿßÿ° ŸÉŸÑÿßÿ≥ ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™
        require_once 'class_Notification.php';
        $notification = new Notification($this->conn);

        // üü¢ ÿ•ÿ¥ÿπÿßÿ± 1 ŸÑŸÑŸÖÿ™ÿ®ÿ±ÿπŸäŸÜ
        $messageToDonors = "üì¢ ÿ™ŸÖ ÿ•ÿ∂ÿßŸÅÿ© ÿ≠ŸÖŸÑÿ© ÿ™ÿ∑ŸàÿπŸäÿ©ÿå ŸÑŸà ŸÖŸáÿ™ŸÖ ÿ®Ÿáÿß ÿ£ŸÜÿ∂ŸÖ ŸÑŸáÿß.";
        $notification->notifyAllDonors($messageToDonors, $campaign_id, 'donation_campaigns');

        // üü¢ ÿ•ÿ¥ÿπÿßÿ± 2 ŸÑÿ®ÿßŸÇŸä ÿßŸÑŸÖŸàÿ∏ŸÅŸäŸÜ
        $messageToStaff = "üì¢ ŸÇÿßŸÖ ÿ£ÿ≠ÿØ ÿßŸÑŸÖŸàÿ∏ŸÅŸäŸÜ ÿ®ÿ•ÿ∂ÿßŸÅÿ© ÿ≠ŸÖŸÑÿ© ÿ™ÿ∑ŸàÿπŸäÿ© ÿ™ÿ≠ÿ™ ÿ•ÿ≥ŸÖ {$name} ŸàŸÖŸÉÿßŸÜŸáÿß {$location} ŸàŸáÿØŸÅŸáÿß ÿ™ÿ¨ŸÖŸäÿπ {$target_units} Ÿàÿ≠ÿØÿ© ÿØŸÖ.";

        $stmtStaff = $this->conn->prepare("SELECT user_id FROM users WHERE role = 'staff' AND user_id != ?");
        $stmtStaff->execute([$staff_id]);
        $staffMembers = $stmtStaff->fetchAll(PDO::FETCH_ASSOC);

        foreach ($staffMembers as $staff) {
            $notification->createNotification([
                'user_id' => $staff['user_id'],
                'recipient_role' => 'staff',
                'message' => $messageToStaff,
                'reference_id' => $campaign_id,
                'reference_type' => 'donation_campaigns'
            ]);
        }
    }

    return $success;
}



    // ÿ¨ŸÑÿ® ÿßŸÑÿ≠ŸÖŸÑÿßÿ™ ÿßŸÑŸÇÿ±Ÿäÿ®ÿ© ŸÖŸÜ ŸÖŸàŸÇÿπ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ (‚â§ 10 ŸÉŸÖ) ŸàŸÑŸÖ ŸäŸÜÿ∂ŸÖ ŸÑŸáÿß ÿ®ÿπÿØ
    public function getNearbyCampaigns($latitude, $longitude, $user_id) {
        $stmt = $this->conn->prepare("SELECT donors_id FROM donors WHERE user_id = ?");
        $stmt->execute([$user_id]);
        $donor = $stmt->fetch(PDO::FETCH_ASSOC);
        $donor_id = $donor['donors_id'] ?? 0;

        $sql = "
            SELECT c.*, 
                   (6371 * acos(
                       cos(radians(?)) * cos(radians(c.latitude)) *
                       cos(radians(c.longitude) - radians(?)) +
                       sin(radians(?)) * sin(radians(c.latitude))
                   )) AS distance
            FROM donation_campaigns c
            LEFT JOIN donations d ON c.donation_campaigns_id = d.donation_campaign_id AND d.donor_id = ?
            WHERE d.donation_campaign_id IS NULL
            HAVING distance <= 10
            ORDER BY distance ASC
        ";

        $stmt = $this->conn->prepare($sql);
        $stmt->execute([$latitude, $longitude, $latitude, $donor_id]);
        return $stmt->fetchAll(PDO::FETCH_ASSOC);
    }

    // ÿ¨ŸÑÿ® ÿ¨ŸÖŸäÿπ ÿßŸÑÿ≠ŸÖŸÑÿßÿ™ ÿßŸÑÿ™Ÿä ŸÑŸÖ ŸäŸÜÿ∂ŸÖ ÿ•ŸÑŸäŸáÿß ÿßŸÑŸÖÿ™ÿ®ÿ±ÿπ
    public function getAllCampaignsExcludingUser($user_id) {
        $stmt = $this->conn->prepare("SELECT donors_id FROM donors WHERE user_id = ?");
        $stmt->execute([$user_id]);
        $donor = $stmt->fetch(PDO::FETCH_ASSOC);
        $donor_id = $donor['donors_id'] ?? 0;

        $sql = "
            SELECT c.*
            FROM donation_campaigns c
            LEFT JOIN donations d ON c.donation_campaigns_id = d.donation_campaign_id AND d.donor_id = ?
            WHERE d.donation_campaign_id IS NULL
            ORDER BY c.campaign_date DESC
        ";

        $stmt = $this->conn->prepare($sql);
        $stmt->execute([$donor_id]);
        return $stmt->fetchAll(PDO::FETCH_ASSOC);
    }

    // ÿßŸÜÿ∂ŸÖÿßŸÖ ÿßŸÑŸÖÿ™ÿ®ÿ±ÿπ ŸÑÿ≠ŸÖŸÑÿ© ÿ™ÿ∑ŸàÿπŸäÿ©
    public function joinCampaign($campaign_id, $user_id) {
        $stmt = $this->conn->prepare("SELECT donors_id FROM donors WHERE user_id = ?");
        $stmt->execute([$user_id]);
        $donor = $stmt->fetch(PDO::FETCH_ASSOC);

        if (!$donor) return false;

        $donor_id = $donor['donors_id'];

        $check = $this->conn->prepare("SELECT * FROM donations WHERE donor_id = ? AND donation_campaign_id = ?");
        $check->execute([$donor_id, $campaign_id]);
        if ($check->fetch()) return false;

        $stmt = $this->conn->prepare("INSERT INTO donations (donor_id, donation_date, donation_campaign_id) VALUES (?, NOW(), ?)");
        return $stmt->execute([$donor_id, $campaign_id]);
    }

    // ÿ¨ŸÑÿ® ÿßŸÑÿ≠ŸÖŸÑÿßÿ™ ÿßŸÑÿ™Ÿä ÿßŸÜÿ∂ŸÖ ÿ•ŸÑŸäŸáÿß ÿßŸÑŸÖÿ™ÿ®ÿ±ÿπ
    public function getJoinedCampaigns($donor_id) {
        $sql = "
            SELECT c.*
            FROM donations d
            JOIN donation_campaigns c ON d.donation_campaign_id = c.donation_campaigns_id
            WHERE d.donor_id = ?
            ORDER BY c.campaign_date DESC
        ";

        $stmt = $this->conn->prepare($sql);
        $stmt->execute([$donor_id]);
        return $stmt->fetchAll(PDO::FETCH_ASSOC);
    }

    // ÿ•ŸÑÿ∫ÿßÿ° ÿßŸÑÿßŸÜÿ∂ŸÖÿßŸÖ ŸÑÿ≠ŸÖŸÑÿ©
    public function cancelJoin($campaign_id, $donor_id) {
        $stmt = $this->conn->prepare("DELETE FROM donations WHERE donation_campaign_id = ? AND donor_id = ?");
        return $stmt->execute([$campaign_id, $donor_id]);
    }


    // ÿ≠ÿ∞ŸÅ ÿ≠ŸÖŸÑÿ© ÿ™ÿ∑ŸàÿπŸäÿ©
public function deleteCampaign($campaign_id) {
    // ÿ¨ŸÑÿ® ÿßÿ≥ŸÖ ÿßŸÑÿ≠ŸÖŸÑÿ© ŸàÿßŸÑŸÖŸàŸÇÿπ ŸÇÿ®ŸÑ ÿßŸÑÿ≠ÿ∞ŸÅ
    $stmtSelect = $this->conn->prepare("SELECT campaign_name, location FROM donation_campaigns WHERE donation_campaigns_id = ?");
    $stmtSelect->execute([$campaign_id]);
    $campaign = $stmtSelect->fetch(PDO::FETCH_ASSOC);

    if (!$campaign) {
        return false; // ŸÑŸÖ Ÿäÿ™ŸÖ ÿßŸÑÿπÿ´Ÿàÿ± ÿπŸÑŸâ ÿßŸÑÿ≠ŸÖŸÑÿ©
    }

    // ÿ™ŸÜŸÅŸäÿ∞ ÿßŸÑÿ≠ÿ∞ŸÅ
    $stmtDelete = $this->conn->prepare("DELETE FROM donation_campaigns WHERE donation_campaigns_id = ?");
    $deleted = $stmtDelete->execute([$campaign_id]);

    if ($deleted) {
        // ÿ•ÿ±ÿ≥ÿßŸÑ ÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ ÿ®ÿπÿØ ÿßŸÑÿ≠ÿ∞ŸÅ
        require_once 'class_Notification.php';
        $notification = new Notification($this->conn);

        $message = "üö´ ŸÇÿßŸÖ ÿ£ÿ≠ÿØ ÿßŸÑŸÖŸàÿ∏ŸÅŸäŸÜ ÿ®ÿ≠ÿ∞ŸÅ ÿ≠ŸÖŸÑÿ© ÿ™ÿ∑ŸàÿπŸäÿ© ÿ®ÿπŸÜŸàÿßŸÜ '{$campaign['campaign_name']}' ŸÅŸä ŸÖŸàŸÇÿπ '{$campaign['location']}'.";

        // ÿ¨ŸÑÿ® ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ ÿßŸÑÿ∞ŸäŸÜ ÿØŸàÿ±ŸáŸÖ staff ÿ£Ÿà admin
        $userStmt = $this->conn->prepare("SELECT user_id FROM users WHERE role IN ('staff', 'admin')");
        $userStmt->execute();
        $users = $userStmt->fetchAll(PDO::FETCH_ASSOC);

        foreach ($users as $user) {
            $notification->addNotification(
                $user['user_id'],
                'staff',
                $message,
                $campaign_id,
                'donation_campaigns'
            );
        }

        return true;
    }

    return false;
}


   public function updateCampaign($campaign_id, $staff_id, $campaign_name, $campaign_date, $location, $description, $target_units, $latitude, $longitude) {
 $stmt = $this->conn->prepare("
        UPDATE donation_campaigns
        SET 
            staff_id = ?, 
            campaign_name = ?, 
            campaign_date = ?, 
            location = ?, 
            description = ?, 
            target_units = ?, 
            latitude = ?, 
            longitude = ?
        WHERE donation_campaigns_id = ?
    ");

    $updated = $stmt->execute([
        $staff_id, $campaign_name, $campaign_date, $location, $description,
        $target_units, $latitude, $longitude, $campaign_id
    ]);

    if ($updated) {
        // ÿ•ÿ±ÿ≥ÿßŸÑ ÿ•ÿ¥ÿπÿßÿ± ÿ®ÿπÿØ ÿßŸÑÿ™ÿ≠ÿØŸäÿ´
        require_once 'class_Notification.php';
        $notification = new Notification($this->conn);

        // ÿµŸäÿßÿ∫ÿ© ÿßŸÑÿ±ÿ≥ÿßŸÑÿ©
        $message = "‚úèÔ∏è ŸÇÿßŸÖ ÿ£ÿ≠ÿØ ÿßŸÑŸÖŸàÿ∏ŸÅŸäŸÜ ÿ®ÿ™ÿπÿØŸäŸÑ ÿßŸÑÿ≠ŸÖŸÑÿ© ÿßŸÑÿ™ÿ∑ŸàÿπŸäÿ© '{$campaign_name}' ŸÅŸä ŸÖŸàŸÇÿπ '{$location}'.";

        // ÿ¨ŸÑÿ® ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ ÿßŸÑÿ∞ŸäŸÜ ÿØŸàÿ±ŸáŸÖ staff ÿ£Ÿà admin
        $userStmt = $this->conn->prepare("SELECT user_id FROM users WHERE role IN ('staff', 'admin')");
        $userStmt->execute();
        $users = $userStmt->fetchAll(PDO::FETCH_ASSOC);

        // ÿ•ÿ±ÿ≥ÿßŸÑ ÿ•ÿ¥ÿπÿßÿ± ŸÑŸÉŸÑ ŸÖÿ≥ÿ™ÿÆÿØŸÖ
        foreach ($users as $user) {
            $notification->addNotification(
                $user['user_id'],          // user_id
                'staff',                   // recipient_role
                $message,                  // message
                $campaign_id,              // reference_id
                'donation_campaigns'       // reference_type
            );
        }
    }

    return $updated;
}

public function getAllCampaigns() {
    $sql = "SELECT * FROM donation_campaigns ORDER BY campaign_date DESC";
    $stmt = $this->conn->prepare($sql);
    $stmt->execute();
    return $stmt->fetchAll(PDO::FETCH_ASSOC);
}

// admin mange campign 

public function getCampaignById($campaign_id) {
    $stmt = $this->conn->prepare("SELECT * FROM donation_campaigns WHERE donation_campaigns_id = ?");
    $stmt->execute([$campaign_id]);
    return $stmt->fetch(PDO::FETCH_ASSOC);
}


public function getCampaignDonors($campaign_id) {
    $query = "
        SELECT u.name AS donor_name, d.blood_type, dn.donation_date
        FROM donations dn
        JOIN donors d ON dn.donor_id = d.donors_id
        JOIN users u ON d.user_id = u.user_id
        WHERE dn.donation_campaign_id = ?
    ";

    $stmt = $this->conn->prepare($query);
    $stmt->execute([$campaign_id]);
    return $stmt->fetchAll(PDO::FETCH_ASSOC);
}

    // ÿßŸÑÿØÿßŸÑÿ© ÿßŸÑÿ¨ÿØŸäÿØÿ© ŸÑŸÑÿ≠ÿ∞ŸÅ
    public function removeCampaignById($id) {
        $sql = "DELETE FROM donation_campaigns WHERE donation_campaigns_id = ?";
        $stmt = $this->conn->prepare($sql);
        return $stmt->execute([$id]);
    }


   

}

?>
